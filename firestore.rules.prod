rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ============================================
    // 프로덕션용 규칙
    // ============================================
    
    // Vehicles collection
    match /vehicles/{vehicleId} {
      // 딜러는 자신의 차량만 읽고 쓸 수 있음
      allow read, write: if request.auth != null && 
        request.auth.token.dealer_id == resource.data.ownerId;
      allow create: if request.auth != null;
    }

    // Auctions collection
    match /auctions/{auctionId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        request.auth.token.dealer_id == resource.data.vehicleOwnerId;
    }

    // Inspections collection
    match /inspections/{inspectionId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null && 
        (request.auth.token.role == 'evaluator' || 
         request.auth.token.dealer_id == resource.data.vehicleOwnerId);
    }

    // Trades collection
    match /trades/{tradeId} {
      allow read, write: if request.auth != null;
    }

    // Logistics collection
    match /logistics/{logisticsId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        request.auth.token.dealer_id == resource.data.vehicleOwnerId;
    }

    // Settlements collection
    match /settlements/{settlementId} {
      allow read, write: if request.auth != null && 
        request.auth.token.dealer_id == resource.data.dealerId;
    }
    
    // Members collection
    match /members/{memberId} {
      allow read: if request.auth != null && request.auth.uid == memberId;
      allow write: if request.auth != null && request.auth.uid == memberId;
    }
  }
}

