# 탁송 플로우(STEP 7-8) 개선 플랜

**작성일**: 2025-01-XX  
**최종 업데이트**: 2025-01-XX (현재 코드 상태 반영)  
**대상**: SCR-0600, SCR-0601, SCR-0105  
**기준 명세**: PRD v2.13 Section 9.4 (FLOW-04) & Section 10.7 (FUNC-22)

---

## 📊 현재 구현 상태 요약 (2025-01-XX 기준)

| 화면 ID | 구현률 | 주요 이슈 | 상태 |
|---------|--------|----------|------|
| SCR-0600 | ~40% | 레이아웃, 자동 채움 미구현 | ❌ 미개선 |
| SCR-0601 | ~30% | 인계 승인 전 확인 단계 없음, 화면 전환 없음 | ❌ 미개선 |
| SCR-0105 | ~70% | 상세 항목 및 AI 분석 부족 | ❌ 미개선 |

### 🔍 현재 코드 상태 확인 결과

**확인 일시**: 2025-01-XX  
**확인 파일**:
- `src/components/LogisticsSchedulePage.tsx` (라인 1-152)
- `src/components/LogisticsHistoryPage.tsx` (라인 1-230)
- `src/components/SettlementDetailPage.tsx` (라인 1-200)

**발견 사항**:
1. ❌ **SCR-0601**: 인계 승인 후 SCR-0105 이동 로직 없음 (라인 67-89 확인)
2. ❌ **SCR-0600**: SKIP 버튼 없음, 출발지/도착지 자동 처리 없음
3. ❌ **SCR-0105**: 탁송비/검차비 항목 없음, 입금 계좌 정보 없음
4. ❌ **HandoverApprovalPage**: 별도 컴포넌트 없음 (모달만 존재)
5. ❌ **Two-Column 레이아웃**: 미적용

---

## 🎯 개선 우선순위

### 🔴 Critical (즉시 수정 필요)

#### 1. SCR-0601 인계 승인 후 화면 전환 로직 추가

**현재 문제**:
- 인계 승인 완료 후 SCR-0105로 이동하지 않음
- 명세: `SCR-0601 → SCR-0105 (인계 승인 완료)`

**작업 내용**:
```typescript
// 파일: src/components/LogisticsHistoryPage.tsx
// 위치: handleApprove 함수 내부

const handleApprove = async () => {
  // ... 기존 PIN 검증 로직 ...
  
  try {
    setIsApproving(true);
    await apiClient.logistics.approveHandover(selectedLogistics.id, pin);
    
    // ✅ 추가: 인계 승인 완료 후 SCR-0105로 이동
    setShowPinModal(false);
    setPin('');
    setSelectedLogistics(null);
    
    // 정산 상세 화면으로 이동 (vehicleId 전달 필요)
    onNavigate('SCR-0105', selectedLogistics.vehicleId);
    
  } catch (error) {
    // ... 에러 처리 ...
  }
};
```

**현재 코드 상태**:
```typescript
// src/components/LogisticsHistoryPage.tsx (라인 67-89)
const handleApprove = async () => {
  // ... PIN 검증 ...
  await apiClient.logistics.approveHandover(selectedLogistics.id, pin);
  // ❌ 문제: alert만 표시하고 화면 전환 없음
  alert('인계 승인이 완료되었습니다.');
  // ✅ 필요: onNavigate('SCR-0105', selectedLogistics.vehicleId) 추가
};
```

**수정 파일**:
- `src/components/LogisticsHistoryPage.tsx` (라인 67-89)

---

#### 2. SCR-0601 인계 승인 화면 구성 개선

**현재 문제**:
- PIN 입력 모달만 있고, 기사 정보/차량 정보/도착 예정 시간 미표시
- 차량 상태 확인서, 차키, 서류 확인 단계 없음

**작업 내용**:

**2-1. 인계 승인 전용 컴포넌트 생성**
```typescript
// 새 파일: src/components/HandoverApprovalPage.tsx
// 명세: SCR-0601의 "Centered Security Card" 레이아웃

interface HandoverApprovalProps {
  logisticsId: string;
  driverInfo: {
    name: string;
    phone: string;
    profileImage?: string;
  };
  vehicleInfo: {
    plateNumber: string;
    modelName: string;
  };
  estimatedArrival: string;
  onApprove: (pin: string) => Promise<void>;
  onNavigate: (screen: string, vehicleId?: string) => void;
}
```

**구현 요소**:
- [ ] 기사님 프로필 사진 영역
- [ ] 성함/연락처 표시
- [ ] 차량 번호 표시
- [ ] 도착 예정 시간 표시
- [ ] 차량 상태 확인서 확인 섹션 (사진 첨부 표시)
- [ ] 차키 인계 확인 체크박스
- [ ] 서류 인계 확인 체크박스
- [ ] 6자리 PIN 입력 필드 (보안 마스킹)
- [ ] 가이드 문구: "차량 상태 확인서에 서명 후, 기사님이 제시하는 PIN 번호를 입력하세요."
- [ ] 승인 버튼 (PIN 6자리 입력 시 활성화)
- [ ] DIR-01 SKIP 버튼

**2-2. LogisticsHistoryPage 수정**
```typescript
// 파일: src/components/LogisticsHistoryPage.tsx

// "인계 승인" 버튼 클릭 시
// 모달 대신 HandoverApprovalPage로 이동하거나
// 모달 내부에 상세 정보 표시 추가
```

**현재 코드 상태**:
```typescript
// src/components/LogisticsHistoryPage.tsx (라인 179-224)
// ❌ 문제: PIN 입력 모달만 있고, 기사 정보/차량 정보/도착 예정 시간 미표시
// ❌ 문제: 차량 상태 확인서, 차키, 서류 확인 단계 없음
{showPinModal && selectedLogistics && (
  <div className="fixed inset-0 ...">
    <div className="bg-white rounded-lg p-6 max-w-md w-full">
      <h3>인계 승인</h3>
      {/* ❌ 기사 정보 없음 */}
      {/* ❌ 차량 정보 없음 */}
      {/* ❌ 도착 예정 시간 없음 */}
      {/* ❌ 확인서/차키/서류 확인 없음 */}
      <input type="text" value={pin} ... /> {/* PIN 입력만 있음 */}
    </div>
  </div>
)}
```

**생성/수정 파일**:
- `src/components/HandoverApprovalPage.tsx` (신규) - **아직 생성 안 됨**
- `src/components/LogisticsHistoryPage.tsx` (수정) - **모달 개선 필요**

---

#### 3. SCR-0600 출발지/도착지 자동 처리

**현재 문제**:
- 출발지 주소 수동 입력
- 도착지(인천항 물류센터) 자동 지정 없음

**작업 내용**:

**3-1. 출발지 자동 채움**
```typescript
// 파일: src/components/LogisticsSchedulePage.tsx

// 차량 등록 시 입력된 주소를 자동으로 가져오기
// vehicleId를 통해 차량 정보 조회
const loadVehicleAddress = async (vehicleId: string) => {
  // API 호출 또는 로컬 상태에서 차량 주소 가져오기
  const vehicle = await apiClient.vehicle.get(vehicleId);
  setAddress(vehicle.registrationAddress); // 자동 채움
};
```

**3-2. 도착지 자동 지정**
```typescript
// 파일: src/components/LogisticsSchedulePage.tsx

const DESTINATION_ADDRESS = "인천광역시 중구 인천항 물류센터"; // 상수로 정의

// 컴포넌트 마운트 시 자동 설정
useEffect(() => {
  if (vehicleId) {
    loadVehicleAddress(vehicleId);
  }
  setDestination(DESTINATION_ADDRESS); // 도착지 자동 지정
}, [vehicleId]);
```

**3-3. UI 개선**
```typescript
// 출발지: 읽기 전용으로 표시 (확인용)
// 도착지: 읽기 전용으로 표시 (자동 지정)
// 특이사항: 새로 추가 (키 위치 등)
```

**현재 코드 상태**:
```typescript
// src/components/LogisticsSchedulePage.tsx (라인 112-125)
// ❌ 문제: 주소를 수동으로 입력해야 함
<textarea
  value={address}
  onChange={(e) => setAddress(e.target.value)}
  placeholder="탁송을 받을 주소를 입력해주세요"
/>
// ✅ 필요: 출발지 자동 채움, 도착지 자동 지정
```

**수정 파일**:
- `src/components/LogisticsSchedulePage.tsx` (라인 1-152)

---

### 🟡 High (중요, 우선 처리 권장)

#### 4. SCR-0105 정산 상세 항목 보완

**현재 문제**:
- 탁송비/검차비 항목 없음
- 입금 계좌 정보 없음
- 상태 배지 없음

**작업 내용**:

**4-1. 정산 항목 추가**
```typescript
// 파일: src/components/SettlementDetailPage.tsx

interface SettlementDetail {
  // ... 기존 필드 ...
  logisticsFee: number;        // 탁송비
  inspectionFee: number;       // 검차비
  bankAccount: string;         // 입금 계좌
  accountHolder: string;       // 예금주
  settlementStatus: 'pending' | 'completed' | 'paid'; // 정산 상태
}
```

**4-2. UI 추가**
```typescript
// 정산 내역 테이블에 추가:
// - 탁송/검차비: (-) 350,000원
// - 입금 계좌: '국민은행 123-***-******'
// - 상태 배지: '정산 완료 (Paid)'
```

**현재 코드 상태**:
```typescript
// src/components/SettlementDetailPage.tsx (라인 126-162)
// ❌ 문제: 탁송비/검차비 항목 없음
// ❌ 문제: 입금 계좌 정보 없음
// ❌ 문제: 상태 배지 없음
<div className="space-y-4">
  {/* 판매가, 플랫폼 수수료, 부가세 환급만 있음 */}
  {/* 탁송비/검차비 없음 */}
  {/* 입금 계좌 없음 */}
</div>
```

**수정 파일**:
- `src/components/SettlementDetailPage.tsx` (라인 126-162)

---

#### 5. DIR-01 SKIP 버튼 추가

**작업 내용**:
- 모든 입력 화면에 SKIP 버튼 추가 (테스트 용이성)

**적용 화면**:
- [ ] SCR-0600 (탁송 예약)
- [ ] SCR-0601 (인계 승인)

**구현 예시**:
```typescript
// 파일: src/components/LogisticsSchedulePage.tsx

const handleSkip = () => {
  // Mock 데이터로 예약 완료 시뮬레이션
  const mockSchedule = {
    schedule_date: new Date().toISOString().split('T')[0],
    schedule_time: '14:00',
    address: '서울특별시 강남구 테헤란로 123'
  };
  
  // Firestore에 저장 (또는 로컬 상태 업데이트)
  setIsConfirmed(true);
  onNavigate('SCR-0601');
};

// UI에 추가
<button
  onClick={handleSkip}
  className="px-4 py-2 border border-fmax-border text-fmax-text-sub rounded-lg hover:bg-fmax-surface"
>
  SKIP (예약 완료 시뮬레이션)
</button>
```

**현재 코드 상태**:
```typescript
// src/components/LogisticsSchedulePage.tsx
// ❌ 문제: SKIP 버튼 없음
// submit 버튼만 있음 (라인 128-144)
```

**수정 파일**:
- `src/components/LogisticsSchedulePage.tsx` - **SKIP 버튼 추가 필요**
- `src/components/HandoverApprovalPage.tsx` (신규) - **아직 생성 안 됨**

---

#### 6. SCR-0600 레이아웃 개선 (Two-Column)

**작업 내용**:
- 명세의 "Two-Column Form Layout" 적용

**레이아웃 구조**:
```
[Left Column]              [Right Column]
- 날짜 선택                - 시간 선택
- 출발지 (읽기 전용)        - 도착지 (읽기 전용)
- 특이사항 입력            - 연락처 확인
```

**수정 파일**:
- `src/components/LogisticsSchedulePage.tsx` (라인 72-146)

---

### 🟢 Medium (권장, 여유 시 처리)

#### 7. SCR-0105 AI 분석 코멘트 추가

**작업 내용**:
```typescript
// 파일: src/components/SettlementDetailPage.tsx

// gemini-3-pro-preview를 사용한 분석 코멘트
const loadAIAnalysis = async (settlementId: string) => {
  const analysis = await apiClient.settlement.getAIAnalysis(settlementId);
  // "평균 시세 대비 12% 높은 수익을 달성했습니다."
};
```

**수정 파일**:
- `src/components/SettlementDetailPage.tsx`
- `src/services/api.ts` (AI 분석 API 추가)

---

#### 8. 상태 전이 로직 보완

**작업 내용**:
- 인계 승인 완료 시 차량 상태를 'Settlement' → 'Sold'로 전이
- 책임 이관 타임스탬프 기록

**수정 파일**:
- `src/components/LogisticsHistoryPage.tsx` 또는 `HandoverApprovalPage.tsx`
- `src/services/api.ts` (상태 전이 API 확인)

---

## 📋 구현 체크리스트 (현재 상태 기준)

### Phase 1: Critical 수정 (즉시) - **0/6 완료**

- [ ] **1-1** SCR-0601 인계 승인 후 SCR-0105 이동 로직 추가 ⚠️ **미구현**
- [ ] **2-1** HandoverApprovalPage 컴포넌트 생성 ⚠️ **미구현**
- [ ] **2-2** 기사 정보/차량 정보/도착 예정 시간 표시 ⚠️ **미구현**
- [ ] **2-3** 차량 상태 확인서/차키/서류 확인 UI 추가 ⚠️ **미구현**
- [ ] **3-1** SCR-0600 출발지 자동 채움 ⚠️ **미구현**
- [ ] **3-2** SCR-0600 도착지 자동 지정 ⚠️ **미구현**

### Phase 2: High 우선순위 (1주 내) - **0/6 완료**

- [ ] **4-1** SCR-0105 탁송비/검차비 항목 추가 ⚠️ **미구현**
- [ ] **4-2** SCR-0105 입금 계좌 정보 표시 ⚠️ **미구현**
- [ ] **4-3** SCR-0105 상태 배지 추가 ⚠️ **미구현**
- [ ] **5-1** DIR-01 SKIP 버튼 추가 (SCR-0600) ⚠️ **미구현**
- [ ] **5-2** DIR-01 SKIP 버튼 추가 (SCR-0601) ⚠️ **미구현**
- [ ] **6-1** SCR-0600 Two-Column 레이아웃 적용 ⚠️ **미구현**

### Phase 3: Medium 우선순위 (2주 내) - **0/3 완료**

- [ ] **7-1** SCR-0105 AI 분석 코멘트 추가 ⚠️ **미구현**
- [ ] **8-1** 상태 전이 로직 보완 ⚠️ **미구현**
- [ ] **8-2** 책임 이관 타임스탬프 기록 ⚠️ **미구현**

**전체 진행률**: 0/15 (0%)

---

## 🔧 기술적 고려사항

### API 연동

**확인 필요 API**:
- [ ] `GET /vehicle/{vehicleId}` - 차량 정보 조회 (주소 포함)
- [ ] `GET /logistics/{logisticsId}/driver-info` - 기사 정보 조회
- [ ] `POST /logistics/handover/{logisticsId}/approve` - 인계 승인 (상태 전이 포함)
- [ ] `GET /settlement/{settlementId}/ai-analysis` - AI 분석 (신규)

### 상태 관리

**추가 필요 상태**:
- 차량 등록 주소 (출발지)
- 기사 정보 (이름, 연락처, 프로필 사진)
- 도착 예정 시간
- 인계 확인 상태 (확인서/차키/서류)

### 데이터 구조

**확장 필요 인터페이스**:
```typescript
// src/types/logistics.ts (신규 파일 권장)
interface LogisticsSchedule {
  vehicleId: string;
  departureAddress: string;  // 출발지 (자동 채움)
  destinationAddress: string; // 도착지 (자동 지정)
  specialNotes?: string;      // 특이사항
  // ...
}

interface HandoverInfo {
  driverInfo: DriverInfo;
  vehicleInfo: VehicleInfo;
  estimatedArrival: string;
  inspectionDocument?: string; // 확인서 사진
  keyHandover: boolean;
  documentHandover: boolean;
}
```

---

## 📝 파일 변경 요약

### 신규 생성 파일
1. `src/components/HandoverApprovalPage.tsx` - 인계 승인 전용 화면
2. `src/types/logistics.ts` - 탁송 관련 타입 정의 (선택)

### 수정 파일
1. `src/components/LogisticsSchedulePage.tsx` - 출발지/도착지 자동 처리, 레이아웃 개선
2. `src/components/LogisticsHistoryPage.tsx` - 인계 승인 후 화면 전환, 상세 정보 표시
3. `src/components/SettlementDetailPage.tsx` - 정산 항목 보완, AI 분석 추가
4. `src/services/api.ts` - API 메서드 추가 (필요 시)

### 라우팅 수정
- `index.tsx` - HandoverApprovalPage 라우트 추가 (필요 시)

---

## 🎯 완료 기준

### Critical 항목 완료 기준
- ✅ 인계 승인 완료 후 SCR-0105로 정상 이동
- ✅ 기사 정보, 차량 정보, 도착 예정 시간 표시
- ✅ 출발지 자동 채움, 도착지 자동 지정 동작 확인
- ✅ 인계 승인 전 확인 단계 (확인서/차키/서류) UI 구현

### High 항목 완료 기준
- ✅ 정산 상세에 탁송비/검차비 항목 표시
- ✅ 입금 계좌 정보 표시
- ✅ SKIP 버튼으로 테스트 플로우 가능
- ✅ Two-Column 레이아웃 적용

### Medium 항목 완료 기준
- ✅ AI 분석 코멘트 표시
- ✅ 상태 전이 로직 정상 동작

---

## 📚 참고 문서

- PRD v2.13 Section 9.4 (FLOW-04: 탁송)
- PRD v2.13 Section 10.7 (FUNC-22: 인계 승인)
- PRD v2.13 Section 10.8 (FUNC-23: 정산 완료 알림)
- `FOWARDMAX/docs/PRD_Phase1_2025-12-31.md`

---

## ⚠️ 주의사항

1. **기존 코드 보존**: RULE-01에 따라 기존 파일 구조를 유지하고 필요한 부분만 수정
2. **명세 우선**: PRD v2.13의 명세를 최우선으로 따름
3. **테스트 용이성**: DIR-01 SKIP 버튼을 통해 개발/테스트 효율성 확보
4. **API 연동**: 백엔드 API 구현 상태 확인 후 프론트엔드 작업 진행

---

## 🚨 즉시 조치 필요 사항

### 최우선 수정 (1시간 내)

1. **SCR-0601 인계 승인 후 화면 전환**
   - 파일: `src/components/LogisticsHistoryPage.tsx`
   - 위치: `handleApprove` 함수 (라인 67-89)
   - 작업: `onNavigate('SCR-0105', selectedLogistics.vehicleId)` 추가
   - 예상 시간: 5분

2. **SCR-0600 출발지/도착지 자동 처리**
   - 파일: `src/components/LogisticsSchedulePage.tsx`
   - 작업: `useEffect`로 차량 주소 자동 로드, 도착지 상수 정의
   - 예상 시간: 15분

### 단기 수정 (오늘 내)

3. **인계 승인 모달 개선**
   - 파일: `src/components/LogisticsHistoryPage.tsx`
   - 작업: 기사 정보, 차량 정보, 도착 예정 시간 표시 추가
   - 예상 시간: 30분

4. **SKIP 버튼 추가**
   - 파일: `src/components/LogisticsSchedulePage.tsx`
   - 작업: DIR-01 SKIP 버튼 추가
   - 예상 시간: 10분

---

## 📝 코드 변경 상세 가이드

### 변경 1: 인계 승인 후 화면 전환 (최우선)

**파일**: `src/components/LogisticsHistoryPage.tsx`

**현재 코드 (라인 67-89)**:
```typescript
const handleApprove = async () => {
  if (!selectedLogistics || pin.length !== 6) {
    alert('6자리 PIN을 입력해주세요.');
    return;
  }

  try {
    setIsApproving(true);
    await apiClient.logistics.approveHandover(selectedLogistics.id, pin);
    setLogistics(prev => prev.map(l => 
      l.id === selectedLogistics.id ? { ...l, status: 'completed' as const } : l
    ));
    setShowPinModal(false);
    setPin('');
    setSelectedLogistics(null);
    alert('인계 승인이 완료되었습니다.'); // ❌ 여기서 끝남
  } catch (error) {
    console.error('Failed to approve handover:', error);
    alert('인계 승인에 실패했습니다.');
  } finally {
    setIsApproving(false);
  }
};
```

**수정 후 코드**:
```typescript
const handleApprove = async () => {
  if (!selectedLogistics || pin.length !== 6) {
    alert('6자리 PIN을 입력해주세요.');
    return;
  }

  try {
    setIsApproving(true);
    await apiClient.logistics.approveHandover(selectedLogistics.id, pin);
    setLogistics(prev => prev.map(l => 
      l.id === selectedLogistics.id ? { ...l, status: 'completed' as const } : l
    ));
    setShowPinModal(false);
    setPin('');
    
    // ✅ 추가: 인계 승인 완료 후 정산 상세 화면으로 이동
    const vehicleId = selectedLogistics.vehicleId;
    setSelectedLogistics(null);
    
    // onNavigate 시그니처 확인 필요: (screen: string, vehicleId?: string)
    onNavigate('SCR-0105', vehicleId);
    
  } catch (error) {
    console.error('Failed to approve handover:', error);
    alert('인계 승인에 실패했습니다.');
  } finally {
    setIsApproving(false);
  }
};
```

**주의사항**:
- `onNavigate` 함수의 시그니처 확인 필요
- `index.tsx`에서 `SCR-0105`가 `settlementId`를 받는지 확인 필요
- 필요시 `vehicleId`를 `settlementId`로 변환하는 로직 추가

---

### 변경 2: 출발지/도착지 자동 처리

**파일**: `src/components/LogisticsSchedulePage.tsx`

**추가할 코드 (라인 1-11 근처)**:
```typescript
import React, { useState, useEffect } from 'react'; // useEffect 추가
// ... 기존 imports ...

const DESTINATION_ADDRESS = "인천광역시 중구 인천항 물류센터";

const LogisticsSchedulePage = ({ onNavigate, vehicleId }: { onNavigate: (screen: string) => void; vehicleId?: string }) => {
  const [selectedDate, setSelectedDate] = useState('');
  const [selectedTime, setSelectedTime] = useState('');
  const [address, setAddress] = useState(''); // 출발지
  const [destination, setDestination] = useState(DESTINATION_ADDRESS); // 도착지
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isConfirmed, setIsConfirmed] = useState(false);

  // ✅ 추가: 차량 주소 자동 로드
  useEffect(() => {
    if (vehicleId) {
      // TODO: API 호출로 차량 정보 가져오기
      // const vehicle = await apiClient.vehicle.get(vehicleId);
      // setAddress(vehicle.registrationAddress);
      
      // 임시: Mock 데이터
      setAddress('서울특별시 강남구 테헤란로 123'); // 차량 등록 주소
    }
    setDestination(DESTINATION_ADDRESS);
  }, [vehicleId]);
```

**UI 수정 (라인 112-125)**:
```typescript
{/* 출발지 (읽기 전용) */}
<div className="bg-white rounded-lg p-6 border border-fmax-border">
  <h2 className="text-lg font-bold text-fmax-text-main mb-4 flex items-center gap-2">
    <MapPin className="w-5 h-5" />
    출발지 (차량 등록 주소)
  </h2>
  <input
    type="text"
    value={address}
    readOnly
    className="w-full px-4 py-3 border border-fmax-border rounded-lg bg-gray-50 text-gray-600"
  />
</div>

{/* 도착지 (자동 지정) */}
<div className="bg-white rounded-lg p-6 border border-fmax-border">
  <h2 className="text-lg font-bold text-fmax-text-main mb-4 flex items-center gap-2">
    <MapPin className="w-5 h-5" />
    도착지
  </h2>
  <input
    type="text"
    value={destination}
    readOnly
    className="w-full px-4 py-3 border border-fmax-border rounded-lg bg-gray-50 text-gray-600"
  />
</div>

{/* 특이사항 (신규 추가) */}
<div className="bg-white rounded-lg p-6 border border-fmax-border">
  <h2 className="text-lg font-bold text-fmax-text-main mb-4">특이사항</h2>
  <textarea
    placeholder="키 위치, 특별 주의사항 등을 입력해주세요"
    rows={3}
    className="w-full px-4 py-3 border border-fmax-border rounded-lg focus:outline-none focus:border-fmax-primary resize-none"
  />
</div>
```

---

**다음 단계**: Phase 1 (Critical) 항목부터 순차적으로 구현 시작

**우선순위**: 변경 1 (인계 승인 후 화면 전환) → 변경 2 (출발지/도착지 자동 처리)

